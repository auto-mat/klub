/*! HtmlTemplateEditorDialog v0.0.1 by Tomas Zigo <tomas.zigo@slovanet.sk> */
(function(){var a,b,c,d,e,f=function(a,b){return function(){return a.apply(b,arguments)}};$(document).ready(function(){var a,b,d,e;return a=500,d=750,e=3e3,b=!0,new c("edit_template_dialog","edit_template",a,"id_template_name","id_template_type","id_hidden_template","field-template","field-template_textarea","id_template_textarea","template_page","id_template",d,b,e),new c("edit_template_dialog","edit_template",a,"id_template_en_name","id_template_en_type","id_hidden_template_en","field-template_en","field-template_en_textarea","id_template_en_textarea","template_page","id_template_en",d,b,e)}),d=function(){function b(a,b,c,d,e,f,g,h,i){this._title=a,this._editTemplateModalDialogId=c,this._backdrop=b,this._$templateNameField=d,this._destroyDelay=e,this._$mountElement=f,this._popoverModalDialogEditTemplateLinkElementId=g,this._$editTemplateModalDialogPageContainer=h,this._$hiddenTemplateField=i,this._$templateDivField=f}return b.editTemplateLinkText=gettext("Edit template"),b.dialogId="edit_template",b.prototype.show=function(b){return b.click(function(b){return function(c){var d,e,f,g;return c.preventDefault(),f=b._$templateNameField.find("option:selected"),e=f.text(),g=f.val().split(":"),d=new a(b._editTemplateModalDialogId,b._popoverModalDialogEditTemplateLinkElementId,b._$editTemplateModalDialogPageContainer,b._$hiddenTemplateField,b._$templateDivField),d.mount(e,"openViaPopoverDialog",g),b.unmount()}}(this)),this.delay(this._destroyDelay,function(a){return function(){return a.unmount()}}(this))},b.prototype.mount=function(a,b){var c;return c=this._getOpt(),c.offsetTop=a,c.offsetLeft=b,WebuiPopovers.show(this._$mountElement,c)},b.prototype.unmount=function(){return this._$mountElement.webuiPopover("hide"),this._$mountElement.webuiPopover("destroy")},b.prototype.delay=function(a,b){return setTimeout(b,a)},b.prototype.getIdFormat=function(a){return"#"+a},b.getContent=function(a,b){var c,d;return c=$("<a></a>"),c.attr({id:this.dialogId,href:""}),d={id:a,"data-type":"modal","data-target":b,"data-fullscreen":"true","data-overlayClick":"true"},c.attr(d),c.html("<b>"+this.editTemplateLinkText+"</b>"),c},b.prototype._getOpt=function(){var a,c;return c=function(a){return function(b){return a.show(b)}}(this),a=b.getContent(this._popoverModalDialogEditTemplateLinkElementId,this.getIdFormat(this._editTemplateModalDialogId)),{placement:"top-right",trigger:"manual,",title:this._title,content:a,offsetTop:0,offsetLeft:0,animation:"fade",backdrop:this._backdrop,onShow:c}},b}(),b=function(){function b(a,b,c,d,e,g,h,i){this._getBtns=f(this._getBtns,this),this._confirmTemplateName=f(this._confirmTemplateName,this),this._dialogId="get_template_name",this._title=gettext("Template name"),this._showDelay=a,this._confirmBtnId="confirm_btn",this._$templateDivField=b,this._templateNameInputId="template_name",this._errorListCSSClass="errorlist",this._templateNameFieldId=c,this._newEmptyTemplateName=null,this._editTemplateModalDialogId=d,this._popoverModalDialogEditTemplateLinkElementId=e,this._templateName=g,this._$editTemplateModalDialogPageContainer=h,this._$hiddenTemplateField=i}return b.prototype.unmount=function(){return $(this.getIdFormat(this._dialogId)).dialog("destroy")},b.prototype.mount=function(){return this._getContainer().dialog(this._getOpt())},b.prototype._getContainer=function(){var a,b,c,d,e,f;return e=$("<div></div>"),e.attr({id:this._dialogId}),f=$("<form></form>"),f.attr({id:"template_name_form"}),a=$("<div></div>"),d=$("<ul></ul>"),d.attr({class:this._errorListCSSClass}),c=$("<label></label>"),c.attr({for:this._templateNameInputId}),c.text(gettext("Template name")),b=$("<input>"),b.attr({id:this._templateNameInputId,name:this._templateNameInputId}),a.append(c),a.append(b),a.append(d),e.append(f.append(a)),e},b.prototype.getNeEmptyTemplateName=function(){return this._newEmptyTemplateName},b.prototype._triggerConfirmBtn=function(){var a;return a=function(a){return function(b){if(b.keyCode===$.ui.keyCode.ENTER)return $(a.getIdFormat(a._confirmBtnId)).click()}}(this),$(this.getIdFormat(this._dialogId)).keypress(a)},b.prototype._checkRegexp=function(a,b,c){var d;return!!b.test(a.val())||(d=a.closest("form").find(this.getClassFormat(this._errorListCSSClass)),d.append("<li>"+c+"</li>"),!1)},b.prototype._checkTemplateName=function(a,b,c){var d,e;return e=[],$(this.getIdFormat(this._templateNameFieldId)+" > option").each(function(){return e.push($(this).text())}),!(e.indexOf(b)>-1)||(d=a.closest("form").find(this.getClassFormat(this._errorListCSSClass)),d.append("<li>"+c+"</li>"),!1)},b.prototype._validateTemplateName=function(){var a,b,c,d;return d=!0,a=$(this.getIdFormat(this._templateNameInputId)),$(this.getClassFormat(this._errorListCSSClass)).html(""),c=gettext("Template name may consist of a-z, 0-9, underscores, not spaces and must begin with a letter,and be lowercase."),d=d&&this._checkRegexp(a,/^[a-z]([0-9a-z_])+$/,c),c=gettext("Template name exist."),b=$(this.getIdFormat(this._templateNameInputId)),d=d&&this._checkTemplateName(b,a.val(),c)},b.prototype._confirmTemplateName=function(){var b,c;if(this._validateTemplateName())return this._newEmptyTemplateName=$(this.getIdFormat(this._templateNameInputId)).val(),this.unmount(),this._setNewEmptyTemplateName(),c=[this._newEmptyTemplateName],b=new a(this._editTemplateModalDialogId,this._popoverModalDialogEditTemplateLinkElementId,this._$editTemplateModalDialogPageContainer,this._$hiddenTemplateField,this._$templateDivField),b.mount(this._templateName,"openViaSelectBox",c)},b.prototype._setNewEmptyTemplateName=function(){if(null!=this._newEmptyTemplateName)return sessionStorage.setItem("newEmptyTemplateName",this._newEmptyTemplateName)},b.prototype._getBtns=function(){var a,b;return a={},b=function(a){return function(){return a._confirmTemplateName()}}(this),a.ok={text:gettext("Ok"),id:this._confirmBtnId,click:b},a},b.prototype._getOpt=function(){var a,b;return b=function(a){return function(b,c){return a._triggerConfirmBtn()}}(this),a=function(a){return function(b,c){return a.unmount(),a._$templateDivField.html("")}}(this),{modal:!0,title:this._title,show:{effect:"fade",delay:this._showDelay},resizable:!1,open:b,beforeClose:a,buttons:this._getBtns()}},b.prototype.getIdFormat=function(a){return"#"+a},b.prototype.getClassFormat=function(a){return"."+a},b}(),a=function(){function a(a,b,c,d,e){this._closeEditTemplateModalDialog=f(this._closeEditTemplateModalDialog,this),this._dialogId=a,this._pageObjectContainerId="template_page",this._sessionStorageKey="dbTemplateName",this._popoverEditTemplateLinkElementId=b,this._closeBtnClass="mdl-close",this._$editTemplateModalDialogPageContainer=c,this._$hiddenTemplateField=d,this._$templateDivField=e}return a.prototype.mount=function(a,b,c){var e,f;if(sessionStorage.removeItem(this._sessionStorageKey),"openViaSelectBox"===b&&(e=d.getContent(this._popoverEditTemplateLinkElementId,this.getIdFormat(this._dialogId)),$("body").append(e)),this.init(this.getIdFormat(d.dialogId)),c.length>1?(f=this._setPageContainerArgs(a,"aklub:get_email_template_from_db"),sessionStorage.setItem(this.sessionStorageKey,f)):f=this._setPageContainerArgs(a,"aklub:get_email_template"),this.show(this.getIdFormat(this._dialogId)),$(this.getClassFormat(this._closeBtnClass)).off("click",this._closeEditTemplateModalDialog),$(this.getClassFormat(this._closeBtnClass)).on("click",this._closeEditTemplateModalDialog),"openViaSelectBox"===b)return $(this.getIdFormat(this._popoverEditTemplateLinkElementId)).remove()},a.prototype._closeEditTemplateModalDialog=function(a){var b;return b=this._getIframeTemplateContent(),new e(b,$(b).find("article"),this._$templateDivField,this._$hiddenTemplateField)},a.prototype._getIframeTemplateContent=function(){var a;return a=document.querySelector(this.getIdFormat(this._$editTemplateModalDialogPageContainer.attr("id"))),null!=a?a.contentDocument:void 0},a.prototype._setPageContainerArgs=function(a,b){var c,d;return d=window.reverse(b,{template_name:a}),c={data:d,width:$(window).width(),height:$(window).height()},$(this.getIdFormat(this._pageObjectContainerId)).attr(c),d},a.prototype.init=function(a){return $(a).mdl()},a.prototype.show=function(a){return mdl_open(a)},a.prototype.getIdFormat=function(a){return"#"+a},a.prototype.getClassFormat=function(a){return"."+a},a}(),c=function(){function c(a,b,c,d,e,g,h,i,j,k,l,m,n,o){this._confirmTemplateEdit=f(this._confirmTemplateEdit,this),this._loadTemplateContent=f(this._loadTemplateContent,this),this._showEditTemplateModalDialog=f(this._showEditTemplateModalDialog,this),this._mouseMoveOverTemplateEvt=f(this._mouseMoveOverTemplateEvt,this),this._replaceTemplateFieldContent=f(this._replaceTemplateFieldContent,this),this._templateDivFieldId=l,this._hiddenTemplateFieldId=g,this._templateNameFieldId=d,this._getTemplateNameDialogShowDelay=c,this._editTemplateModalDialogId=a,this._popoverModalDialogEditTemplateLinkElementId=b,this._templateDivFormFieldContainerCSSClass=h,this._templateTextareaFieldId=j,this._editTemplateModalDialogPageContainerId=k,this._$templateDivFieldContainer=null,this._$templateTextareaFieldContainer=null,this._templateTextareaFieldValue="",this._showPopoverModalDialogDelay=m,this._popoverModalDialogBackDrop=n,this._popoverModalDialogDestroyDelay=o,this._templateTextAreaFormFieldContainerCSSClass=i,this._templateTypeFieldId=e,this._newEmptyTemplateName=null,this._getTemplateNameDialog=null,this._popoverDialogOpts=null,this._cacheDom(),this._bindEvents(),this._bindPopoverDialogMouseMoveEvt(),this._templateFormFieldWidgetInit()}return c.prototype._cacheDom=function(){return this._$templateDivField=$(this.getIdFormat(this._templateDivFieldId)),this._$hiddenTemplateField=$(this.getIdFormat(this._hiddenTemplateFieldId)),this._$templateNameField=$(this.getIdFormat(this._templateNameFieldId)),this._$templateTypeField=$(this.getIdFormat(this._templateTypeFieldId)),this._$templateDivFormFieldContainer=$(this.getClassFormat(this._templateDivFormFieldContainerCSSClass)),this._$templateTextAreaFormFieldContainer=$(this.getClassFormat(this._templateTextAreaFormFieldContainerCSSClass)),this._$templateTextareaField=$(this.getIdFormat(this._templateTextareaFieldId)),this._$editTemplateModalDialogPageContainer=$(this.getIdFormat(this._editTemplateModalDialogPageContainerId))},c.prototype._bindEvents=function(){return this._$templateNameField.bind("change",this._showEditTemplateModalDialog),this._$templateTypeField.bind("change",this._replaceTemplateFieldContent),this._$editTemplateModalDialogPageContainer.bind("load",this._loadTemplateContent)},c.prototype._templateFormFieldWidgetInit=function(){var a;return this._$templateTextAreaFormFieldContainer.addClass("hidden"),"new"===this._$templateTypeField.val()?(this._exchangeFormFieldContainerContent(),a=this._$templateDivField.html(),this._$templateTextareaField.html(a),this._templateTextareaFieldValue=a,this._$templateDivField.html("")):"existed"===this._$templateTypeField.val()?this._$hiddenTemplateField.val(this._$templateDivField.html()):void 0},c.prototype._getTemplateFieldContainer=function(){this._$templateDivFieldContainer=this._$templateDivFormFieldContainer,this._$templateTextareaFieldContainer=this._$templateTextAreaFormFieldContainer},c.prototype._checkTemplateFieldWidget=function(){var a;return this._getTemplateFieldContainer(),a=this._$templateDivFieldContainer.find("textarea"),a.length?"textarea":"div"},c.prototype._replaceTemplateFieldContent=function(a){var b;b=$(a.target).val(),"new"===b?"textarea"!==this._checkTemplateFieldWidget()&&this._exchangeFormFieldContainerContent():"existed"===b&&"div"!==this._checkTemplateFieldWidget()&&this._exchangeFormFieldContainerContentBack()},c.prototype._exchangeFormFieldContainerContentBack=function(){var a;return this._disableFormFieldWysiwygEditor(),this._$templateNameField.attr("disabled",!1),this._exchangeContent(),a={id:this._templateTextareaFieldId,name:this._templateTextareaFieldId.slice(3)},this._$templateDivField.attr(a),a={id:this._templateDivFieldId,name:this._templateDivFieldId.slice(3)},this._$templateTextareaField.attr(a),this._bindPopoverDialogMouseMoveEvt()},c.prototype.delay=function(a,b){return setTimeout(b,a)},c.prototype._mouseMoveOverTemplateEvt=function(a){var b,c,d,e,f;return b=$(a.currentTarget).offset(),e=a.pageX-b.left,f=a.pageY-b.top,d=f,c=e,this.delay(this._showPopoverModalDialogDelay,function(a){return function(){return a._initPopoverModalDialog(d,c)}}(this))},c.prototype._initPopoverModalDialog=function(a,b){return this._popoverDialogOpts.mount(a,b)},c.prototype._bindPopoverDialogMouseMoveEvt=function(){return this._popoverDialogOpts=new d(gettext("Edit template"),this._popoverModalDialogBackDrop,this._editTemplateModalDialogId,this._$templateNameField,this._popoverModalDialogDestroyDelay,this._$templateDivField,this._popoverModalDialogEditTemplateLinkElementId,this._$editTemplateModalDialogPageContainer,this._$hiddenTemplateField),this._$templateDivField.mousemove(this._mouseMoveOverTemplateEvt)},c.prototype._exchangeFormFieldContainerContent=function(){var a;return this._$templateTextareaField.html(this._templateTextareaFieldValue),this._$templateNameField.attr("disabled",!0),this._exchangeContent(),a={id:this._templateTextareaFieldId,name:this._templateTextareaFieldId.slice(3)},this._$templateDivField.attr(a),this._$templateDivFieldContainer.find("label").attr("for",this._templateDivFieldId),this._$templateDivFieldContainer.find("label").text(this._$templateTextareaFieldContainer.find("label").text()),a={id:this._templateDivFieldId,name:this._templateDivFieldId.slice(3)},this._$templateTextareaField.attr(a),this._enableFormFieldWysiwygEditor(),this._$templateTextAreaFormFieldContainer.addClass("hidden"),this._$hiddenTemplateField.val("")},c.prototype._enableFormFieldWysiwygEditor=function(){return django_wysiwyg.enable(this._templateDivFieldId.slice(3))},c.prototype._disableFormFieldWysiwygEditor=function(){return django_wysiwyg.disable(this._templateDivFieldId.slice(3))},c.prototype._exchangeContent=function(){var a,b;this._getTemplateFieldContainer(),a=this._$templateDivFieldContainer.children(),b=this._$templateTextareaFieldContainer.children(),this._$templateDivFieldContainer.html(b),this._$templateTextareaFieldContainer.html(a)},c.prototype._showEditTemplateModalDialog=function(c){var d,e,f,g;if(sessionStorage.removeItem("newEmptyTemplateName"),e=""+this.getIdFormat(c.target.id),f=$(e+" option:selected").text(),$(""+e).val().length>0)return"new_empty_template"===f?(this._getTemplateNameDialog=new b(this._getTemplateNameDialogShowDelay,this._$templateDivField,this._templateNameFieldId,this._editTemplateModalDialogId,this._popoverModalDialogEditTemplateLinkElementId,f,this._$editTemplateModalDialogPageContainer,this._$hiddenTemplateField),this._getTemplateNameDialog.mount()):(g=this._$templateNameField.find("option:selected").val().split(":"),d=new a(this._editTemplateModalDialogId,this._popoverModalDialogEditTemplateLinkElementId,this._$editTemplateModalDialogPageContainer,this._$hiddenTemplateField,this._$templateDivField),d.mount(f,"openViaSelectBox",g))},c.prototype._loadTemplateContent=function(a){var b;if(this._newEmptyTemplateName=null!=(b=this._getTemplateNameDialog)?b.getNeEmptyTemplateName():void 0,null!=this._newEmptyTemplateName)return this._addEditTemplateConfirmEvent()},c.prototype._addEditTemplateConfirmEvent=function(){var a,b,c,d;return b="ct-ignition__button--confirm",d=document.querySelector(this.getIdFormat(this._editTemplateModalDialogPageContainerId)),c=d.contentDocument,a=$(c).find(this.getClassFormat(b)),a.unbind("click"),a.bind("click",this._confirmTemplateEdit)},c.prototype._confirmTemplateEdit=function(){if(null!=this._newEmptyTemplateName)return this._addNewSelectOpt(this._newEmptyTemplateName,this._$templateNameField),this.__eraseNewTemplateName()},c.prototype._eraseNewTemplateName=function(){return this._newEmptyTemplateName=null},c.prototype._addNewSelectOpt=function(a,b){var c,d;return d="new_empty_template:"+a,c=new Option(a,d),b.append(c),b.val(d)},c.prototype.getIdFormat=function(a){return"#"+a},c.prototype.getClassFormat=function(a){return"."+a},c}(),e=function(){function a(a,b,c,d){this._htmlDoc=a,this._$editTemplatePageContainer=b,this._$templateDivField=c,this._$hiddenTemplateField=d,this._videoClass="video",this._textContainerTags=["p","ul","ol","h1","h2","h3","h4","h5","h6"],this.convertVideoIframeToImgThumbnail(this._htmlDoc),this.convertCssToInlineStyle(this._htmlDoc,this._$editTemplatePageContainer)}return a.prototype.convertVideoIframeToImgThumbnail=function(a){var b,c;return c=new RegExp("youtube.com.*(v=|/embed/)(.{11})"),b=new RegExp("vimeo.com.*(.{8})"),$(a).find("iframe").each(function(a,d){var e,f,g,h,i,j,k,l,m,n;return j=$(d).attr("src"),h=$(d).css("float"),k=$(d).attr("width"),i=$(d).attr("height"),e=$('<a href="" class="video"></a>'),e.attr("href",j),f=$('<img src="">'),f.attr({width:k,height:i}),j.match(c)?(m=j.match(c).pop(),e.attr("id",m),e.addClass("youtube"),n="//img.youtube.com/vi/"+m+"/0.jpg",f.attr("src",n)):j.match(b)&&(m=j.match(b).pop(),e.attr("id",m),e.addClass("vimeo"),l=function(a){return function(a){return n=a[0].thumbnail_large,$(d).videoThumbnail.attr("src",n)}}(),g={type:"GET",url:"http://vimeo.com/api/v2/video/"+m+".json",jsonp:"callback",dataType:"jsonp",context:{videoThumbnail:f},success:l},$.ajax(g)),f.css("float",h),e.append(f),$(d).after(e),$(d).remove()})},a.prototype.convertCssToInlineStyle=function(a,b){return this.inlineStyler($(a)),this.replaceImgSrc(b),this.convertTextCssPositionToTable(b),this._$templateDivField.html(b),this._$hiddenTemplateField.val(b.html())},a.prototype.inlineStyler=function(a){return a.inlineStyler()},a.prototype.getElementPosition=function(a,b,c){var d,e,f,g;return null==b&&(b=""),null==c&&(c=""),d=$("<table></table>"),d.attr({cellspacing:0,cellpadding:0,border:0,width:"100%"}),e=$("<tbody></tbody>"),g=$("<tr></tr>"),f=$("<td></td>"),f.css({border:"none",padding:0,margin:0}),f.attr({align:a,width:b,heigth:c}),d.append(e.append(g.append(f)))},a.prototype.replaceImgSrc=function(a){var b;return b=a.find("img"),b.each(function(b){return function(c,d){var e,f,g,h,i;return e=$(d).closest(b.getClassFormat(b._videoClass)),f=e.length>0?e:$(d),0===e.length&&(i=$(d).attr("src"),h=new RegExp(window.origin),i.match(h)||(g=""+window.origin+$(d).attr("src"),$(d).attr("src",g))),b.convertImageCssPositionToTable(f,a)}}(this))},a.prototype.convertImageCssPositionToTable=function(a,b){var c,d,e,f,g,h,i;a=a.find("img").length>0?a.find("img"):a,g=parseInt(a.css("margin-left").split(".")[0].replace("px","")),h=parseInt(a.css("margin-right").split(".")[0].replace("px","")),f=a.css("float"),a.css("display",""),g===h&&"none"===f?d=this.getElementPosition("center","",""):g>h?(d=this.getElementPosition(f,a.attr("width"),a.attr("height")),c=this.convertImgFloatCssPositionToTable(a,b,f)):h>g?(d=this.getElementPosition(f,a.attr("width"),a.attr("height")),c=this.convertImgFloatCssPositionToTable(a,b,f)):"left"!==f&&"right"!==f||(d=this.getElementPosition(f,a.attr("width"),a.attr("height")),c=this.convertImgFloatCssPositionToTable(a,b,f)),i=this.getClassFormat(this._videoClass),e=a.closest(i),d.find("td").append(e.length>0?e.clone():a.clone()),"left"===f?d.find("tr").append(c):d.find("tr").prepend(c),e.length>0?e.after(d):a.after(d),e.length>0?e.remove():a.remove(),console.log(d)},a.prototype.convertImgFloatCssPositionToTable=function(a,b,c){var d,e,f,g,h,i,j;return i=15,j="left"===c?"0 0 0 "+i+"px":"0 "+i+"px 0 0",e=$("<td></td>"),e.css({border:"none",padding:j,margin:"0"}),f=a.closest(this.getClassFormat(this._videoClass)),d=f.length>0?f.next().clone():a.next().clone(),h=parseFloat(b.find("#content_table").width()),g=h-parseFloat(a.attr("width"))-i,d.css("width",g),e.attr("width",g),e.append(d),f.length>0?f.next().remove():a.next().remove(),e},a.prototype.convertTextCssPositionToTable=function(a){return a.find(this._textContainerTags.join(", ")).each(function(a){return function(b,c){var d,e;switch(e=$(c).attr("class")?$(c).attr("class").split(" "):[]){case e.indexOf("text-left")>-1:d=a.getElementPosition("left","","");break;case e.indexOf("text-right")>-1:d=a.getElementPosition("right","","");break;case e.indexOf("text-center")>-1:d=a.getElementPosition("center","","");break;default:d=a.getElementPosition("center","","")}return a.adjustListCssProperties($(c)),d.find("td").append($(c).clone()),$(c).after(d),$(c).remove()}}(this))},a.prototype.adjustListCssProperties=function(a){if(a.is("ul")||a.is("ol"))return a.css({margin:"10px",padding:"15px"})},a.prototype.getClassFormat=function(a){return"."+a},a}()}).call(this);